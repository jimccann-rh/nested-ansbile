---
# Playbook to configure existing vCenter (without deploying VMs)

- name: Prepare dynamic inventory
  hosts: remotedevqe
  gather_facts: false
  tasks:
    - name: Add ESXi hosts to esxi group
      ansible.builtin.add_host:
        name: '{{ item }}'
        groups: esxi
      loop: "{{ nested_esxi_hosts }}"
      when: nested_esxi_hosts is defined and nested_esxi_hosts | length > 0

    - name: Add vCenter hosts to vc group
      ansible.builtin.add_host:
        name: '{{ item }}'
        groups: vc
      loop: "{{ nested_vcenter_hosts }}"
      when: nested_vcenter_hosts is defined and nested_vcenter_hosts | length > 0

  tags: always

- name: Configure nested vCenter infrastructure
  hosts: remotedevqe
  gather_facts: false
  serial: 1
  tasks:
    - name: Create datacenter and cluster
      ansible.builtin.include_role:
        name: vcenter_datacenter
      run_once: true
      when: groups['vc'] is defined and groups['vc'] | length > 0

    - name: Configure ESXi hosts in vCenter
      ansible.builtin.include_role:
        name: vcenter_host_config
      loop: "{{ groups['esxi'] }}"
      loop_control:
        loop_var: loop_bms
        index_var: my_idx
      when: groups['esxi'] is defined and groups['esxi'] | length > 0

    - name: Configure storage
      ansible.builtin.include_role:
        name: vcenter_storage
      vars:
        vcenter_storage_nfs_enabled: "{{ nfsetup | default(false) }}"
      loop: "{{ groups['esxi'] }}"
      loop_control:
        loop_var: loop_bms
        index_var: my_idx
      when: groups['esxi'] is defined and groups['esxi'] | length > 0

    - name: Configure networking
      ansible.builtin.include_role:
        name: vcenter_networking
      loop: "{{ groups['esxi'] }}"
      loop_control:
        loop_var: loop_bms
        index_var: my_idx
      when: groups['esxi'] is defined and groups['esxi'] | length > 0

  tags: ['configure', 'vcenter_config']
